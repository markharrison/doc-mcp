<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-mcp-auth" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">MCP Authentication / Authorization | Model Context Protocol (MCP)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://markharrison.io/doc-mcp/mcp-auth"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="MCP Authentication / Authorization | Model Context Protocol (MCP)"><meta data-rh="true" name="description" content="In the previous section we covered the development of an MCP Server.  In this section we shall extend the server code so that it supports authentication / authorization."><meta data-rh="true" property="og:description" content="In the previous section we covered the development of an MCP Server.  In this section we shall extend the server code so that it supports authentication / authorization."><link data-rh="true" rel="icon" href="/doc-mcp/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://markharrison.io/doc-mcp/mcp-auth"><link data-rh="true" rel="alternate" href="https://markharrison.io/doc-mcp/mcp-auth" hreflang="en"><link data-rh="true" rel="alternate" href="https://markharrison.io/doc-mcp/mcp-auth" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"MCP AuthN/AuthZ","item":"https://markharrison.io/doc-mcp/mcp-auth"}]}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J96E5KV7Z6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-J96E5KV7Z6",{anonymize_ip:!0})</script><link rel="stylesheet" href="/doc-mcp/assets/css/styles.efd89cb2.css">
<script src="/doc-mcp/assets/js/runtime~main.c51cea82.js" defer="defer"></script>
<script src="/doc-mcp/assets/js/main.3f64744f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://markharrison.io/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/doc-mcp/img/logol.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/doc-mcp/img/logod.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Mark Harrison</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/doc-mcp/">Model Context Protocol (MCP)</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/markharrison/doc-mcp" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc-mcp/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc-mcp/why-mcp">Why MCP?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc-mcp/what-is-mcp">What is MCP?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/doc-mcp/mcp-demo-vsc">MCP Demos</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/doc-mcp/mcp-development">MCP Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/doc-mcp/mcp-auth">MCP AuthN/AuthZ</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/doc-mcp/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">MCP AuthN/AuthZ</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>MCP Authentication / Authorization</h1></header>
<p>In the previous section we covered the development of an MCP Server.  In this section we shall extend the server code so that it supports authentication / authorization.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="objectives">Objectives<a href="#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives">​</a></h2>
<p>Authentication and authorization are essential for both the MCP service provider and the user. Each party must be able to verify the identity of the other to establish trust and enforce appropriate access controls.</p>
<p>From the MCP Server&#x27;s perspective, it may be necessary to authenticate and identify the user. This enables the server to apply role-based access controls and enforce policies based on various user attributes - such as identity, role, or organizational affiliation.</p>
<p>From the MCP client&#x27;s perspective, it is equally important to authenticate the service. Users must be confident they connecting to a trusted and verified service endpoint.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authentication--authorization-flow">Authentication / Authorization flow<a href="#authentication--authorization-flow" class="hash-link" aria-label="Direct link to Authentication / Authorization flow" title="Direct link to Authentication / Authorization flow">​</a></h2>
<p>In our example setup, the following components participate in the authentication and authorization process:</p>
<ul>
<li>
<p>Microsoft Entra acts as the OAuth 2.1 Authorization Server, issuing access tokens to authenticated users.</p>
</li>
<li>
<p>Visual Studio Code hosts the MCP Client, functioning as the OAuth 2.1 client.</p>
</li>
<li>
<p>The ColorsMCP server is the OAuth 2.1 protected resource server, validating access tokens presented by the client. If a request lacks a valid token - maybe due to it being missing, invalid content, or expired - the server responds with an HTTP 401 Unauthorized status.</p>
</li>
</ul>
<p>Should a 401 be returned, the MCP Client queries an endpoint at the URL <code>./well-known/oauth-protected-resource</code> to retrieve information needed for authentication - this includes the address of the Entra tenant. The flow redirects the user to Entra, where they are prompted to authenticate. Upon successful authentication, the MCP Client receives an access token, which it attaches to a retry of the original request to the MCP Server. The MCP Server then validates the token - if it is valid, access is granted; otherwise, the process repeats.</p>
<p>As part of the authentication process, the user is shown a consent screen detailing what information will be shared and what permissions the application is requesting. The user can choose whether to proceed. In enterprise environments, administrators may grant consent on behalf of all users in the organization.</p>
<p>The access token follows the JWT (JSON Web Token) standard. It is a cryptographically signed string that contains information (claims) about the user&#x27;s identity and, typically, their access permissions (such as roles or scopes). The signature ensures the token&#x27;s integrity - proving it was issued by Entra and preventing forgery. You can learn more at <a href="https://jwt.io/introduction" target="_blank" rel="noopener noreferrer">https://jwt.io/introduction</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="colors-mcp-server">Colors MCP Server<a href="#colors-mcp-server" class="hash-link" aria-label="Direct link to Colors MCP Server" title="Direct link to Colors MCP Server">​</a></h2>
<p>The source code to the ColorsMCP server is at : <a href="https://github.com/markharrison/ColorsMCP" target="_blank" rel="noopener noreferrer">https://github.com/markharrison/ColorsMCP</a></p>
<p>The original version of ColorsMCP is in the project:</p>
<ul>
<li>ColorsMCP-HTTP</li>
</ul>
<p>Using this as the starting point, the following project includes additional authentication/authorization logic:</p>
<ul>
<li>ColorsMCP-HTTP-Auth</li>
</ul>
<p>As before, most of the heavy lifting is done by the MCP C# SDK.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="colorsmcp-http-auth">ColorsMCP-HTTP-Auth<a href="#colorsmcp-http-auth" class="hash-link" aria-label="Direct link to ColorsMCP-HTTP-Auth" title="Direct link to ColorsMCP-HTTP-Auth">​</a></h3>
<p>Check <code>program.cs</code> and compare to the original.</p>
<p>The following configuration values are required to support authentication and authorization:</p>
<ul>
<li>
<p><code>ServerUrl</code> – The URL of the MCP Server. This is the endpoint to which the MCP Client sends requests.</p>
</li>
<li>
<p><code>TenantId</code> – This value uniquely identifies the Entra tenant that belongs to us and manages the users for authentication and token issuance. Since many organizations use Microsoft Entra ID, it’s necessary to distinguish our tenant from others.</p>
</li>
<li>
<p><code>Audience</code> – The identifier of the MCP Server, the intended recipient of the access token. This ensures the MCP Server only accepts tokens meant for it.</p>
</li>
<li>
<p><code>Scope</code> – Specifies the permissions or access rights requested by the client. Scopes define what the client can do once authorized, such as reading data or accessing specific API features.</p>
</li>
</ul>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> var builder = WebApplication.CreateBuilder(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var serverUrl = builder.Configuration[&quot;ServerUrl&quot;] ?? &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var tenantId = builder.Configuration[&quot;TenantId&quot;] ?? &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var audience = builder.Configuration[&quot;Audience&quot;] ?? &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var scope = builder.Configuration[&quot;Scope&quot;] ?? &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var oAuthServerUrl = $&quot;https://login.microsoftonline.com/{tenantId}/v2.0&quot;;</span><br></span></code></pre></div></div>
<p>The following code adds the authentication / authorization rules.</p>
<ul>
<li><code>AddAuthentication</code> defines the authentication scheme</li>
</ul>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> builder.Services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .AddAuthentication(options =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             options.DefaultChallengeScheme = McpAuthenticationDefaults.AuthenticationScheme;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         })</span><br></span></code></pre></div></div>
<ul>
<li><code>AddJwtBearer</code> sets the rules used to validate the JWT access token. It also includes event handlers for token validation success and failure.</li>
</ul>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     .AddJwtBearer(options =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             options.Authority = oAuthServerUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             options.TokenValidationParameters = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new Microsoft.IdentityModel.Tokens.TokenValidationParameters</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ValidateIssuer = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ValidateAudience = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ValidateLifetime = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ValidateIssuerSigningKey = true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ValidAudience = $&quot;api://{audience}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 ValidIssuers = new[]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     oAuthServerUrl,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     $&quot;https://sts.windows.net/{tenantId}/&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 NameClaimType = &quot;name&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 RoleClaimType = &quot;roles&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             options.MetadataAddress = $&quot;{oAuthServerUrl}/.well-known/openid-configuration&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             options.Events = new JwtBearerEvents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 OnTokenValidated = context =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     var name = context.Principal?.Identity?.Name ?? &quot;unknown&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     var upn = context.Principal?.FindFirstValue(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            &quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn&quot;) ?? &quot;unknown&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     Console.ForegroundColor = ConsoleColor.Yellow;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     Console.WriteLine($&quot;Token validated for: {name} ({upn})&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     Console.ResetColor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 OnAuthenticationFailed = context =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     Console.ForegroundColor = ConsoleColor.Red;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     Console.WriteLine($&quot;Authentication failed: {context.Exception.Message}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     Console.ResetColor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         })</span><br></span></code></pre></div></div>
<ul>
<li><code>AddMcp</code> logic defines the <code>ResourceMetadata</code> - this is information retrieved from the <code>./well-known/oauth-protected-resource</code> endpoint.  It includes the address of the Entra authentication service.</li>
</ul>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     .AddMcp(options =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         options.ResourceMetadata = new()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             Resource = new Uri(serverUrl),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ResourceDocumentation = new Uri(&quot;https://github.com/markharrison/colorsmcp&quot;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             AuthorizationServers = { new Uri(oAuthServerUrl) },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ScopesSupported = [$&quot;api://{audience}/{scope}&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     });</span><br></span></code></pre></div></div>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> builder.Services.AddAuthorization();</span><br></span></code></pre></div></div>
<p>The remainder of code is similar to before - just injecting <code>UseAuthentication</code> / <code>UseAuthorization</code> into the execution pipeline.</p>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> builder.Services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .AddMcpServer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .WithHttpTransport()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .WithTools&lt;ColorsTools&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> builder.Services.AddCors(options =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     options.AddDefaultPolicy(policy =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         policy.AllowAnyOrigin()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               .AllowAnyHeader()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               .AllowAnyMethod();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> builder.Services.AddSingleton&lt;ColorsService&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var app = builder.Build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> var colorsService = app.Services.GetRequiredService&lt;ColorsService&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> app.UseAuthentication();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> app.UseAuthorization();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> app.UseCors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> app.MapMcp().RequireAuthorization();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> app.MapGet(&quot;/health&quot;, () =&gt; &quot;Healthy&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Console.WriteLine($&quot;Starting MCP server with authz: {serverUrl}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Console.WriteLine($&quot;OAuth server at {oAuthServerUrl}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Console.WriteLine($&quot;Protected Resource Metadata URL: {serverUrl}.well-known/oauth-protected-resource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> app.Run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-microsoft-entra">Configuring Microsoft Entra<a href="#configuring-microsoft-entra" class="hash-link" aria-label="Direct link to Configuring Microsoft Entra" title="Direct link to Configuring Microsoft Entra">​</a></h2>
<p>To enable secure access, we need to create an App Registration in Microsoft Entra for the ColorsMCP server. This registration represents the resource server in the OAuth 2.1 flow and will be used to:</p>
<ul>
<li>
<p>Define the scopes (permissions) that clients must request to access protected MCP resources.</p>
</li>
<li>
<p>Establish a unique Application (Client) ID that identifies the ColorsMCP server.</p>
</li>
<li>
<p>Configure Entra to issue access tokens that the MCP Clients present when calling the ColorsMCP server. These tokens allow the server to validate and authorize incoming API requests based on the token integrity and assigned scopes.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="create-mcp-server-app-registration">Create MCP Server App Registration<a href="#create-mcp-server-app-registration" class="hash-link" aria-label="Direct link to Create MCP Server App Registration" title="Direct link to Create MCP Server App Registration">​</a></h3>
<ul>
<li>Go to <a href="https://entra.microsoft.com" target="_blank" rel="noopener noreferrer">https://entra.microsoft.com</a></li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth1-3538f2747648b0d76db3999ba1618629.png" width="1280" height="659" class="img_ev3q"></p>
<ul>
<li>
<p>Note the Tenant Id - this will be needed for application configuration.</p>
</li>
<li>
<p>Using Left Hand menu select <code>Entra ID</code> | <code>App registrations</code></p>
</li>
<li>
<p>Select <code>New Registration</code></p>
</li>
<li>
<p>Enter a name e.g. ColorsMCP-Server</p>
</li>
<li>
<p>Select <code>Register</code></p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth2-7d4b1612ffb5db9c713df3fc9ef09706.png" width="1280" height="1071" class="img_ev3q"></p>
<ul>
<li>
<p>Using menu blade, select <code>Manage</code> | <code>Expose an API</code></p>
</li>
<li>
<p>Create Application Id - click <code>Add</code> to create a unique id.  Note the number created, it will be needed for our application configuration</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth3-3a3cd4e578536b61e4b6da6ae6952da4.png" width="1280" height="1071" class="img_ev3q"></p>
<ul>
<li>
<p>Next click <code>Add a scope</code> and enter a value - for example &#x27;mcptools.colors&#x27;.   The scope value will be needed for our application configuration</p>
</li>
<li>
<p>Allow both admins and users consent .  This means anyone can grant consent to use the MCP Server.</p>
</li>
<li>
<p>Click <code>Add scope</code></p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth4-4fca791aa944ff917106d7c52ab730f1.png" width="1280" height="1071" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth5-37702dcd5c495a54c957b19b58fcde04.png" width="1280" height="1071" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update-application-configuration">Update Application Configuration<a href="#update-application-configuration" class="hash-link" aria-label="Direct link to Update Application Configuration" title="Direct link to Update Application Configuration">​</a></h3>
<p>We are now ready to update the application&#x27;s configuration. Below are my example values - be sure to replace them with your own values.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ServerUrl&quot;: &quot;http://localhost:59254/&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;TenantId&quot;: &quot;95fdb808-f6f3-4abc-9cb2-8a86090ea39a&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Audience&quot;: &quot;32d051c8-2de2-47b0-b1fe-29c3007e5f87&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;Scope&quot;: &quot;mcptools.colors&quot;</span><br></span></code></pre></div></div>
<p>The Server URL is a local address used by Visual Studio.   There is a Docker file in the project to build a Docker image / container that makes it easy to deploy the MCP Server to something like Azure App Service.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuring-visual-studio">Configuring Visual Studio<a href="#configuring-visual-studio" class="hash-link" aria-label="Direct link to Configuring Visual Studio" title="Direct link to Configuring Visual Studio">​</a></h2>
<p>Recapping from an earlier section ... the .vscode\mcp.json file contains the configuration to the MCP Server.</p>
<p>Add the lines with the URL to the MCP Server application</p>
<ul>
<li>
<p>Click on the grey link to <code>Start</code></p>
</li>
<li>
<p>The MCP Server will signal to the MCP Client that the user must authenticate.  Click the button to <code>Allow</code>.</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authvsc1-cabf6af06c2b7dc8abbc35bdd8976e71.png" width="1280" height="1008" class="img_ev3q"></p>
<ul>
<li>
<p>We now get prompted with an Entra login screen</p>
</li>
<li>
<p>Enter your user credentials, and do MFA if necessary</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authvsc2-3c19ec97eb40674f94402a4a480eb0bb.png" width="1280" height="1007" class="img_ev3q"></p>
<ul>
<li>
<p>When authenticated, a consent screen will be displayed</p>
</li>
<li>
<p>Grant permission for the MCP Server to be used</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authvsc3-2bea21c51a5c4948d5cf7944c3e82492.png" width="1280" height="1008" class="img_ev3q"></p>
<ul>
<li>
<p>The MCP Server should now show as &#x27;Running&#x27;.</p>
</li>
<li>
<p>Looking at the logged in users, we can examine the Trusted MCP Servers</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authvsc4-c98abc9507b138e3fed9ee2f22b362bf.png" width="1280" height="1009" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-colorsmcp-server">Using the ColorsMCP Server<a href="#using-the-colorsmcp-server" class="hash-link" aria-label="Direct link to Using the ColorsMCP Server" title="Direct link to Using the ColorsMCP Server">​</a></h2>
<p>To call our MCP Server, within GitHub Copilot Agent mode - use a prompt like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">I need a palette of four colors from the green family - plus black ... </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   please add to colors.html so I can inspect</span><br></span></code></pre></div></div>
<p>Looking at the application&#x27;s console log - we can see that the token has been validated and the user identified from information stored within the access token.</p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authlog1-6cbd24c9987ed6975595fd958f176af9.png" width="1395" height="1070" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="inspecting-the-access-token">Inspecting the Access Token<a href="#inspecting-the-access-token" class="hash-link" aria-label="Direct link to Inspecting the Access Token" title="Direct link to Inspecting the Access Token">​</a></h3>
<p>In the OnTokenValidated event handler we can add a line to display the access token.</p>
<div class="language-C# language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Console.ForegroundColor = ConsoleColor.Cyan;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Console.WriteLine($&quot;JWT Token: {context.SecurityToken}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Console.ResetColor();</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authlog2-9129d37fb2c84d604ba3d1ad508752ae.png" width="1280" height="373" class="img_ev3q"></p>
<p>To inspect the contents of the access token - we can use the website <a href="https://jws.ms/" target="_blank" rel="noopener noreferrer">https://jws.ms/</a>.</p>
<p>Copy and paste the token from the console log into this web site.</p>
<p>The invididual items within the access token are called claims.  We can see the claims about the user, the audience and the scopes.</p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authjwt1-6fef8dcd6d83d92a19f0181e9a2dfcaf.png" width="1280" height="1392" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="inspecting-the-oauth-protected-resource-document">Inspecting the OAuth Protected Resource document<a href="#inspecting-the-oauth-protected-resource-document" class="hash-link" aria-label="Direct link to Inspecting the OAuth Protected Resource document" title="Direct link to Inspecting the OAuth Protected Resource document">​</a></h3>
<p>Near the top of the console log, the application displayed the URL of the OAuth Protected Resource document. Check out this address - it gives information for the MCP Client to know how to authenticate e.g. the address of the Entra tenant.</p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/authapr-fc8522100362cfe02c7b2e4f33d52d49.png" width="1280" height="422" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="client-app-registration">Client App Registration<a href="#client-app-registration" class="hash-link" aria-label="Direct link to Client App Registration" title="Direct link to Client App Registration">​</a></h2>
<p>Normally with OAuth, we also need to create a Client App Registration - which connects to the Server App Registration.  But we didn&#x27;t need to do this ...</p>
<p>If we check Entra we can see an Enterprise App registration for Visual Studio Code.</p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth6-74cf7206a2a2eafac0f476fe73e50fc2.png" width="1280" height="807" class="img_ev3q"></p>
<p>And it has automatically configured the connection to the MCP Server with the &#x27;mcptools.colors&#x27; scope.</p>
<p><img decoding="async" loading="lazy" alt="screenshot" src="/doc-mcp/assets/images/auth7-f02dc0aa8075e9fe84496f542451d82c.png" width="1280" height="1071" class="img_ev3q"></p>
<p>As the number of MCS servers grows, configuration becomes increasingly demanding - so this automated setup reduces the efforts needed while ensuring accurate token issuance, scope management, and validation.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/doc-mcp/mcp-development"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MCP Development</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objectives" class="table-of-contents__link toc-highlight">Objectives</a></li><li><a href="#authentication--authorization-flow" class="table-of-contents__link toc-highlight">Authentication / Authorization flow</a></li><li><a href="#colors-mcp-server" class="table-of-contents__link toc-highlight">Colors MCP Server</a><ul><li><a href="#colorsmcp-http-auth" class="table-of-contents__link toc-highlight">ColorsMCP-HTTP-Auth</a></li></ul></li><li><a href="#configuring-microsoft-entra" class="table-of-contents__link toc-highlight">Configuring Microsoft Entra</a><ul><li><a href="#create-mcp-server-app-registration" class="table-of-contents__link toc-highlight">Create MCP Server App Registration</a></li><li><a href="#update-application-configuration" class="table-of-contents__link toc-highlight">Update Application Configuration</a></li></ul></li><li><a href="#configuring-visual-studio" class="table-of-contents__link toc-highlight">Configuring Visual Studio</a></li><li><a href="#using-the-colorsmcp-server" class="table-of-contents__link toc-highlight">Using the ColorsMCP Server</a><ul><li><a href="#inspecting-the-access-token" class="table-of-contents__link toc-highlight">Inspecting the Access Token</a></li><li><a href="#inspecting-the-oauth-protected-resource-document" class="table-of-contents__link toc-highlight">Inspecting the OAuth Protected Resource document</a></li></ul></li><li><a href="#client-app-registration" class="table-of-contents__link toc-highlight">Client App Registration</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class="footer__links"><a href="https://twitter.com/azure1dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><span class="footer__link-separator">·</span><a href="https://github.com/markharrison" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><span class="footer__link-separator">·</span><a href="https://www.linkedin.com/in/markharrison-uk/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Mark Harrison</div></div></div></footer></div>
</body>
</html>